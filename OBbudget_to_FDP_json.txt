//description of how to create a FDP datapackage json descriptor from a RDF OBEU spending dataset
//covers all OBEU spending properties - omit those unused in a specific dataset
//expressions in "{ }" suggest how to retrieve the value from a given dataset in a SPARQL-like syntax
//more complex description on how to implement the OBEU-to-FDP conversion are in // comments 
{
  //local_part_of_iri is a made-up function returning substring after the last / or # from IRI
  "name": "{local_part_of_iri(?dataset)}", //{?dataset a qb:DataSet .}
  "title": "?dataset rdfs:label ?title",
  "license": "cc-by 3.0",
  "profiles": {
    "fiscal": "*",
    "tabular": "*"
  },
  
  "granularity": //"transaction" if obeu-dimension:date used on observations, "aggregated" if obeu-dimension:fiscalPeriod or its subproperty is used on observations
  
  "fiscalPeriod": {
    "start": //oldest date in the dataset: extract date part from oldest ?date in ?observation (any subproperty of)sdmx-dimension:refPeriod [time:hasBeginning [time:inXSDDateTime ?date]]
    "end": //newest date in the dataset: extract date part from newest ?date in ?observation (any subproperty of)sdmx-dimension:refPeriod [time:hasEnd [time:inXSDDateTime ?date]]
  }, 
  "resources": [
    {
      "name": "observationsFile",
      "path": "observationsFile.csv",
      "schema": {
        "fields": [
          {
            "name": "organization_id",
            "type": "string",
            "format": "uri"
          },
          {
            "name": "partner_id",
            "type": "string",
            "format": "uri"
          },
          {
            "name": "date",
            "type": "datetime"
          },
          {
            "name": "budgetLine",
            "type": "string",
            "format": "uri"
          },
          {
            "name": "project_id",
            "type": "string",
            "format": "uri"
          },
          {
            "name": "taxesIncluded",
            "type": "boolean"
          }, 
          //for each ?programmeClassification as a subproperty of obeu-dimension:programmeClassification:        
          {
            "name": "{concat(local_part_of_iri(?programmeClassification),'_id'}",
            "type": "string",
            "format": "uri"            
          },
          //for each ?economicClassification as a subproperty of obeu-dimension:economicClassification
          {
            "name": "{concat(local_part_of_iri(?economicClassification),'_id'}",
            "type": "string",
            "format": "uri"            
          },
          //for each ?administrativeClassification as a subproperty of obeu-dimension:economicClassification
          {
            "name": "{concat(local_part_of_iri(?administrativeClassification),'_id'}",
            "type": "string",
            "format": "uri"            
          },
          {
            "name": "accountingRecord_id",
            "type": "string",
            "format": "uri" 
          },
          {
            "name": "location_id",
            "type": "string",
            "format": "uri" 
          }
         ]         
        },
        "foreignKeys": [            
          {
            "fields": "organization_id",
            "reference": {
                "datapackage": "{local_part_of_iri(?dataset)}",
                "resource": "entitiesFile",
                "fields": "id" 
            }
          },
          {
            "fields": "partner_id",
            "reference": {
                "datapackage": "{local_part_of_iri(?dataset)}",
                "resource": "entitiesFile",
                "fields": "id" 
            }
          },
          {
            "fields": "project_id",
            "reference": {
                "datapackage": "{local_part_of_iri(?dataset)}",
                "resource": "projectsFile",
                "fields": "id" 
            }
          },
          //for each ?functionalClassification as a subproperty of obeu-dimension:functionalClassification:
          {
            "fields": "{concat(local_part_of_iri(?functionalClassification),'_id'}",
            "reference": {
                "datapackage": "{local_part_of_iri(?dataset)}",
                "resource": "functionsFile",
                "fields": "id" 
            }
          },
          //for each ?programmeClassification as a subproperty of obeu-dimension:programmeClassification:
          {
            "fields": "{concat(local_part_of_iri(?programmeClassification),'_id'}",
            "reference": {
                "datapackage": "{local_part_of_iri(?dataset)}",
                "resource": "programmesFile",
                "fields": "id" 
            }
          },
          //for each ?economicClassification as a subproperty of obeu-dimension:economicClassification
          {
            "fields": "{concat(local_part_of_iri(?economicClassification),'_id'}",
            "reference": {
                "datapackage": "{local_part_of_iri(?dataset)}",
                "resource": "economicConceptsFile",
                "fields": "id" 
            }
          },
          //for each ?administrativeClassification as a subproperty of obeu-dimension:economicClassification
          {
            "fields": "{concat(local_part_of_iri(?administrativeClassification),'_id'}",
            "reference": {
                "datapackage": "{local_part_of_iri(?dataset)}",
                "resource": "administrativeConceptsFile",
                "fields": "id" 
            }
          },
          //(end foreach)
          {
            "fields": "location_id",
            "reference": {
                "datapackage": "{local_part_of_iri(?dataset)}",
                "resource": "locationsFile",
                "fields": "id" 
            }
          }
          //for each of remaining custom dimension as ?customDimension
          //WHERE {?someObservation ?customDimension [skos:prefLabel ?something; skos:notation ?somethingElse]}
          // (at least one of skos:notation or skos:prefLabel)
          //BIND(local_part_of_iri(?customDimension) as ?customDimensionName)
          //BIND(concat(?customDimensionName, "File") as ?customDimensionFile)
          ,{
            "fields": "{concat(?customDimensionName,'_id'}",
            "reference": {
                "datapackage": "{local_part_of_iri(?dataset)}",
                "resource": "{?customDimensionFile}",
                "fields": "id" 
            }
          }
        ]
      },
      {
        "name": "entitiesFile",
        "path": "entitiesFile.csv",
        "schema": {
          "fields": [
            {
              "name": "id",
              "type": "string",
              "format": "uri" 
            },
            {
              "name": "label",
              "type": "string"            
            }            
          ]
        }            
      },
      {
        "name": "projectsFile",
        "path": "projectsFile.csv",
        "schema": {
          "fields": [
            {
              "name": "id",
              "type": "string",
              "format": "uri" 
            },
            {
              "name": "label",
              "type": "string"            
            },
            {
              "name": "adms_id",
              "type": "string"            
            }
          ]
        }
      },
      {
        "name": "functionsFile",
        "path": "functionsFile.csv",
        "schema" {
          "fields" [
            {
              "name": "id",
              "type": "string",
              "format": "uri" 
            },
            {
              "name": "skosPrefLabel",
              "type": "string"
            },
            {
              "name": "skosNotation",
              "type": "string"
            }
          ]
        }
      },
      {
        "name": "programmesFile",
        "path": "programmesFile.csv",
        "schema" {
          "fields" [
            {
              "name": "id",
              "type": "string",
              "format": "uri" 
            },
            {
              "name": "skosPrefLabel",
              "type": "string"
            },
            {
              "name": "skosNotation",
              "type": "string"
            }
          ]
        }
      },
      {
        "name": "economicConceptsFile",
        "path": "economicConceptsFile.csv",
        "schema" {
          "fields" [
            {
              "name": "id",
              "type": "string",
              "format": "uri" 
            },
            {
              "name": "skosPrefLabel",
              "type": "string"
            },
            {
              "name": "skosNotation",
              "type": "string"
            }
          ]
        }
      },
      {
        "name": "administrativeConceptsFile",
        "path": "administrativeConceptsFile.csv",
        "schema" {
          "fields" [
            {
              "name": "id",
              "type": "string",
              "format": "uri" 
            },
            {
              "name": "skosPrefLabel",
              "type": "string"
            },
            {
              "name": "skosNotation",
              "type": "string"
            }
          ]
        }
      },
      {
        "name": "locationsFile",
        "path": "locationsFile.csv",
        "schema" {
          "fields" [
            {
              "name": "id",
              "type": "string",
              "format": "uri" 
            },
            {
              "name": "schemaName",
              "type": "string"
            },
            {
              "name": "schemaDescription",
              "type": "string"
            }
          ]
        }
      }
      //for each ?customDimensionFile
      ,{
        "name": "{?customDimensionFile}",
        "path": "{?customDimensionFile}.csv",
        "schema" {
          "fields" [
            {
              "name": "id",
              "type": "string",
              "format": "uri" 
            },
            {
              "name": "skosPrefLabel",
              "type": "string"
            },
            {
              "name": "skosNotation",
              "type": "string"
            }
          ]
        }
      }        
    ],
  
  "mapping": {
    
    "measures": {
      // for each measure ?measure in the dataset:
      "{local_part_of_iri(?measure)}": {
        "source": "{local_part_of_iri(?measure)}",
        
        //datasets with different currencies in one measure have to be split by currency into separate datapackages
        "currency": "{[] obeu-attribute:currency [skos:notation ?currency]; qb:measureType ?measure .}",
        "resource": "observationsFile",
        
        //datasets with different operation characters in one measure have to be split by operation character; or this attribute might be omitted as it is optional
        "direction": "{[] obeu-dimension:operationCharacter [skos:preferredLabel ?direction]}",
        
        //datasets with different budgetPhases in one measure have to be split by the phase
        "phase": //use following mapping of values of obeu-dimension:budgetPhase
        //obeu-budgetphase:draft -> "proposed"
        //obeu-budgetphase:revised -> "adjusted"
        //obeu-budgetphase:approved -> "approved"
        //obeu-budgetphase:executed -> "executed"          
        
      }
    },
    
    "dimensions": {
       "budgetaryUnit": {
          "attributes": {
            "id": {
              "source": "budgetaryUnit_id",
              "resource": "observationsFile"              
            },
            "label" {
              "source": "label",
              "resource": "entitiesFile",
              "labelfor": "id"
            }
          }
          "primaryKey":  "organization_id",
          "dimensionType": "entity" //open an issue for this: no difference between payer and payee                                    
       },
       "fiscalPeriod": {
        "attributes": {
           "hasBeginning": {
             "source": "fiscalPeriodStart",
             "resource": "observationsFile"
           },            
           "hasEnd": {
             "source": "fiscalPeriodEnd",
             "resource": "observationsFile"
           }
           "primaryKey": ["hasBeginning", "hasEnd"], 
           "dimensionType": "date"
        }
       },
       "fiscalYear": {
        "attributes": {
           "year": {
             "source": "fiscalYear",
             "resource": "observationsFile"
           },
           "primaryKey": "year", 
           "dimensionType": "date"
        }
       },
        "taxesIncluded": {
          "attributes": {
            "source": "taxesIncluded",
            "resource": "observationsFile"
          },
          "primaryKey": "taxesIncluded",
          "dimensionType": "other"                 
        },
        //for each ?functionalClassification as a subproperty of obeu-dimension:functionalClassification
        "{local_part_of_iri(?functionalClassification)}": {
          "attributes": {
             "{concat(local_part_of_iri(?functionalClassification),'_id'}": {
               "source": "{concat(local_part_of_iri(?functionalClassification),'_',id}",
               "resource": "observationsFile" 
             },
             "{concat(local_part_of_iri(?functionalClassification),'_skosPrefLabel'}": {
               "source": "skosPrefLabel",
               "resource": "functionsFile",
               "labelfor": "{concat(local_part_of_iri(?functionalClassification),'_id'}" 
             },    
             "{concat(local_part_of_iri(?functionalClassification),'_skosNotation'}": {
               "source": "skosNotation",
               "resource": "functionsFile" 
             }
          },
          "primaryKey": "{concat(local_part_of_iri(?programmeClassification),'_id'}",
          "dimensionType": "classification",
          "classificationType": "functional"           
        },
        //for each ?programmeClassification as a subproperty of obeu-dimension:programmeClassification
        "{local_part_of_iri(?programmeClassification)}": {
          "attributes": {
             "{concat(local_part_of_iri(?programmeClassification),'_id'}": {
               "source": "{concat(local_part_of_iri(?programmeClassification),'_',id}",
               "resource": "observationsFile" 
             },
             "{concat(local_part_of_iri(?programmeClassification),'_skosPrefLabel'}": {
               "source": "skosPrefLabel",
               "resource": "programmesFile",
               "labelfor": "{concat(local_part_of_iri(?programmeClassification),'_id'}" 
             },    
             "{concat(local_part_of_iri(?programmeClassification),'_skosNotation'}": {
               "source": "skosNotation",
               "resource": "programmesFile" 
             }
          },
          "primaryKey": "{concat(local_part_of_iri(?programmeClassification),'_id'}",
          "dimensionType": "activity"           
        },
        //for each ?economicClassification as a subproperty of obeu-dimension:economicClassification
        "{local_part_of_iri(?economicClassification)}": {
          "attributes": {
             "{concat(local_part_of_iri(?economicClassification),'_id'}": {
               "source": "{concat(local_part_of_iri(?economicClassification),'_',id}",
               "resource": "observationsFile" 
             },
             "{concat(local_part_of_iri(?economicClassification),'_skosPrefLabel'}": {
               "source": "{concat(local_part_of_iri(?economicClassification),'_skosPrefLabel'}",
               "resource": "economicConceptsFile", 
               "labelfor": "{concat(local_part_of_iri(?economicClassification),'_id'}" 
             },    
             "{concat(local_part_of_iri(?economicClassification),'_skosNotation'}": {
               "source": "{concat(local_part_of_iri(?economicClassification),'_skosNotation'}",
               "resource": "economicConceptsFile" 
             }
          },
          "primaryKey": "{concat(local_part_of_iri(?economicClassification),'_id'}",
          "dimensionType": "classification",
          "classificationType": "economic"           
        },                 
        //for each ?administrativeClassification as a subproperty of obeu-dimension:administrativeClassification
        "{local_part_of_iri(?administrativeClassification)}": {
          "attributes": {
             "{concat(local_part_of_iri(?administrativeClassification),'_id'}": {
               "source": "{concat(local_part_of_iri(?administrativeClassification),'_',id}",
               "resource": "observationsFile" 
             },
             "{concat(local_part_of_iri(?administrativeClassification),'_skosPrefLabel'}": {
               "source": "{concat(local_part_of_iri(?administrativeClassification),'_skosPrefLabel'}",
               "resource": "administrativeConceptsFile",
              "labelfor": "{concat(local_part_of_iri(?administrativeClassification),'_id'}" 
             },    
             "{concat(local_part_of_iri(?administrativeClassification),'_skosNotation'}": {
               "source": "{concat(local_part_of_iri(?administrativeClassification),'_skosNotation'}",
               "resource": "administrativeConceptsFile" 
             }
          },
          "primaryKey": "{concat(local_part_of_iri(?administrativeClassification),'_id'}",
          "dimensionType": "classification",
          "classificationType": "administrative"           
        }
        
        //for each of remaining custom dimension as ?customDimension
        //WHERE {?someObservation ?customDimension [skos:prefLabel ?something; skos:notation ?somethingElse]}
        // (at least one of skos:notation or skos:prefLabel)
        //BIND(local_part_of_iri(?customDimension) as ?customDimensionName)
        //BIND(concat(?customDimensionName, "File") as ?customDimensionFile)
        ,"{?customDimensionName}": {
          "attributes": {
             "{concat(?customDimensionName,'_id'}": {
               "source": "{concat(local_part_of_iri(?administrativeClassification),'_',id}",
               "resource": "observationsFile" 
             },
             "{concat(?customDimensionName,'_skosPrefLabel'}": {
               "source": "{concat(?customDimensionName,'_skosPrefLabel'}",
               "resource": "{?customDimensionFile}",
              "labelfor": "{concat(?customDimensionName,'_id'}" 
             },    
             "{concat(?customDimensionName,'_skosNotation'}": {
               "source": "{concat(?customDimensionName,'_skosNotation'}",
               "resource": "{?customDimensionFile}" 
             }
          },
          "primaryKey": "{concat(local_part_of_iri(?administrativeClassification),'_id'}",
          "dimensionType": "classification",
          "classificationType": "administrative"           
        }
        //for each custom attribute as ?attribute
        //WHERE {?attribute a qb:AttributeProperty . 
        //      ?someObservation ?attribute ?attrVal .
        //      ?someObservation }
        //TBD              
    }
  }
  
}